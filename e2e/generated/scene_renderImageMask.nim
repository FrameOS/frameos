# This file is autogenerated

{.warning[UnusedImport]: off.}
import pixie, json, times, strformat, strutils, sequtils, options, algorithm

import frameos/values
import frameos/types
import frameos/channels
import frameos/utils/image
import frameos/utils/url
import apps/render/split/app as render_splitApp
import apps/render/image/app as render_imageApp
import apps/data/localImage/app as data_localImageApp
import apps/render/text/app as render_textApp
import apps/render/color/app as render_colorApp
import apps/data/newImage/app as data_newImageApp

const DEBUG = false
let PUBLIC_STATE_FIELDS*: seq[StateField] = @[]
let PERSISTED_STATE_KEYS*: seq[string] = @[]

type Scene* = ref object of FrameScene
  node1: render_splitApp.App
  node2: render_imageApp.App
  node3: render_imageApp.App
  node4: render_imageApp.App
  node5: render_imageApp.App
  node6: render_imageApp.App
  node7: render_imageApp.App
  node8: render_imageApp.App
  node9: data_localImageApp.App
  node10: data_localImageApp.App
  node11: render_textApp.App
  node12: render_imageApp.App
  node13: render_textApp.App
  node14: render_imageApp.App
  node15: render_textApp.App
  node16: render_imageApp.App
  node17: render_imageApp.App
  node18: render_imageApp.App
  node19: render_imageApp.App
  node20: render_splitApp.App
  node21: data_newImageApp.App
  node22: render_colorApp.App

{.push hint[XDeclaredButNotUsed]: off.}
var cache0: Option[Image] = none(Image)
var cache0Time: float = 0
var cache1: Option[Image] = none(Image)
var cache1Time: float = 0
var cache2: Option[Image] = none(Image)

proc runNode*(self: Scene, nodeId: NodeId, context: var ExecutionContext, asDataNode = false): Value =
  result = VNone()
  let scene = self
  let frameConfig = scene.frameConfig
  let state = scene.state
  var nextNode = nodeId
  var currentNode = nodeId
  var timer = epochTime()
  while nextNode != -1.NodeId:
    currentNode = nextNode
    timer = epochTime()
    case nextNode:
    of 1.NodeId: # render/split
      self.node1.run(context)
      nextNode = -1.NodeId
    of 2.NodeId: # render/image
      self.node2.appConfig.image = block:
        self.node8.appConfig.image = block:
          if cache1.isNone() or epochTime() > cache1Time + 900.0:
            cache1 = some(block:
              self.node10.get(context))
            cache1Time = epochTime()
          cache1.get()
        self.node8.appConfig.inputImage = some(block:
          if cache0.isNone() or epochTime() > cache0Time + 900.0:
            cache0 = some(block:
              self.node9.get(context))
            cache0Time = epochTime()
          cache0.get())
        self.node8.get(context)
      self.node2.run(context)
      nextNode = 11.NodeId
    of 6.NodeId: # render/image
      self.node6.appConfig.image = block:
        self.node12.appConfig.image = block:
          if cache1.isNone() or epochTime() > cache1Time + 900.0:
            cache1 = some(block:
              self.node10.get(context))
            cache1Time = epochTime()
          cache1.get()
        self.node12.appConfig.inputImage = some(block:
          if cache0.isNone() or epochTime() > cache0Time + 900.0:
            cache0 = some(block:
              self.node9.get(context))
            cache0Time = epochTime()
          cache0.get())
        self.node12.get(context)
      self.node6.run(context)
      nextNode = 13.NodeId
    of 4.NodeId: # render/image
      self.node4.appConfig.image = block:
        self.node14.appConfig.inputImage = some(block:
          if cache0.isNone() or epochTime() > cache0Time + 900.0:
            cache0 = some(block:
              self.node9.get(context))
            cache0Time = epochTime()
          cache0.get())
        self.node14.appConfig.image = block:
          if cache1.isNone() or epochTime() > cache1Time + 900.0:
            cache1 = some(block:
              self.node10.get(context))
            cache1Time = epochTime()
          cache1.get()
        self.node14.get(context)
      self.node4.run(context)
      nextNode = 15.NodeId
    of 11.NodeId: # render/text
      self.node11.run(context)
      nextNode = -1.NodeId
    of 15.NodeId: # render/text
      self.node15.run(context)
      nextNode = -1.NodeId
    of 13.NodeId: # render/text
      self.node13.run(context)
      nextNode = -1.NodeId
    of 3.NodeId: # render/image
      self.node3.appConfig.image = block:
        self.node16.appConfig.image = block:
          if cache0.isNone() or epochTime() > cache0Time + 900.0:
            cache0 = some(block:
              self.node9.get(context))
            cache0Time = epochTime()
          cache0.get()
        self.node16.appConfig.inputImage = some(block:
          if cache1.isNone() or epochTime() > cache1Time + 900.0:
            cache1 = some(block:
              self.node10.get(context))
            cache1Time = epochTime()
          cache1.get())
        self.node16.get(context)
      self.node3.run(context)
      nextNode = -1.NodeId
    of 5.NodeId: # render/image
      self.node5.appConfig.image = block:
        self.node17.appConfig.inputImage = some(block:
          if cache1.isNone() or epochTime() > cache1Time + 900.0:
            cache1 = some(block:
              self.node10.get(context))
            cache1Time = epochTime()
          cache1.get())
        self.node17.appConfig.image = block:
          if cache0.isNone() or epochTime() > cache0Time + 900.0:
            cache0 = some(block:
              self.node9.get(context))
            cache0Time = epochTime()
          cache0.get()
        self.node17.get(context)
      self.node5.run(context)
      nextNode = -1.NodeId
    of 7.NodeId: # render/image
      self.node7.appConfig.image = block:
        self.node18.appConfig.inputImage = some(block:
          if cache1.isNone() or epochTime() > cache1Time + 900.0:
            cache1 = some(block:
              self.node10.get(context))
            cache1Time = epochTime()
          cache1.get())
        self.node18.appConfig.image = block:
          if cache0.isNone() or epochTime() > cache0Time + 900.0:
            cache0 = some(block:
              self.node9.get(context))
            cache0Time = epochTime()
          cache0.get()
        self.node18.get(context)
      self.node7.run(context)
      nextNode = -1.NodeId
    of 19.NodeId: # render/image
      self.node19.appConfig.image = block:
        self.node20.appConfig.inputImage = some(block:
          if cache2.isNone():
            cache2 = some(block:
              self.node21.get(context))
          cache2.get())
        self.node20.get(context)
      self.node19.run(context)
      nextNode = 1.NodeId
    of 22.NodeId: # render/color
      self.node22.run(context)
      nextNode = -1.NodeId
    else:
      nextNode = -1.NodeId
    
    if DEBUG:
      self.logger.log(%*{"event": "debug:scene", "node": currentNode, "ms": (-timer + epochTime()) * 1000})

proc runEvent*(self: Scene, context: var ExecutionContext) =
  case context.event:
  of "render":
    try: discard self.runNode(19.NodeId, context)
    except Exception as e: self.logger.log(%*{"event": "render:error", "node": 19, "error": $e.msg, "stacktrace": e.getStackTrace()})
  of "setSceneState":
    if context.payload.hasKey("state") and context.payload["state"].kind == JObject:
      let payload = context.payload["state"]
      for field in PUBLIC_STATE_FIELDS:
        let key = field.name
        if payload.hasKey(key) and payload[key] != self.state{key}:
          self.state[key] = copy(payload[key])
    if context.payload.hasKey("render"):
      sendEvent("render", %*{})
  of "setCurrentScene":
    if context.payload.hasKey("state") and context.payload["state"].kind == JObject:
      let payload = context.payload["state"]
      for field in PUBLIC_STATE_FIELDS:
        let key = field.name
        if payload.hasKey(key) and payload[key] != self.state{key}:
          self.state[key] = copy(payload[key])
  else: discard

proc runEvent*(self: FrameScene, context: var ExecutionContext) =
    runEvent(Scene(self), context)

proc render*(self: FrameScene, context: var ExecutionContext): Image =
  let self = Scene(self)
  context.image.fill(self.backgroundColor)
  runEvent(self, context)
  return context.image

proc init*(sceneId: SceneId, frameConfig: FrameConfig, logger: Logger, persistedState: JsonNode): FrameScene =
  var state = %*{}
  if persistedState.kind == JObject:
    for key in persistedState.keys:
      state[key] = persistedState[key]
  let scene = Scene(id: sceneId, frameConfig: frameConfig, state: state, logger: logger, refreshInterval: 3600.0, backgroundColor: parseHtmlColor("#000000"))
  let self = scene
  result = scene
  var context = ExecutionContext(scene: scene, event: "init", payload: state, hasImage: false, loopIndex: 0, loopKey: ".")
  scene.execNode = (proc(nodeId: NodeId, context: var ExecutionContext) = discard scene.runNode(nodeId, context))
  scene.getDataNode = (proc(nodeId: NodeId, context: var ExecutionContext): Value = scene.getDataNode(nodeId, context))
  scene.node1 = render_splitApp.App(nodeName: "render/split", nodeId: 1.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_splitApp.AppConfig(
    rows: 3,
    columns: 2,
    inputImage: none(Image),
    hideEmpty: false,
    render_functions: @[
      @[
        2.NodeId,
        3.NodeId,
      ],
      @[
        4.NodeId,
        5.NodeId,
      ],
      @[
        6.NodeId,
        7.NodeId,
      ],
    ],
    render_function: 0.NodeId,
  ))
  scene.node9 = data_localImageApp.App(nodeName: "data/localImage", nodeId: 9.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: data_localImageApp.AppConfig(
    path: "./assets/bird.png",
    order: "random",
    counterStateKey: "",
    search: "",
  ))
  scene.node9.init()
  scene.node8 = render_imageApp.App(nodeName: "render/image", nodeId: 8.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    blendMode: "mask",
    inputImage: some(block:
      if cache0.isNone() or epochTime() > cache0Time + 900.0:
        cache0 = some(block:
          self.node9.get(context))
        cache0Time = epochTime()
      cache0.get()),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
  ))
  scene.node10 = data_localImageApp.App(nodeName: "data/localImage", nodeId: 10.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: data_localImageApp.AppConfig(
    path: "./assets/mask.png",
    order: "random",
    counterStateKey: "",
    search: "",
  ))
  scene.node10.init()
  scene.node2 = render_imageApp.App(nodeName: "render/image", nodeId: 2.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    inputImage: none(Image),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node6 = render_imageApp.App(nodeName: "render/image", nodeId: 6.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    inputImage: none(Image),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node12 = render_imageApp.App(nodeName: "render/image", nodeId: 12.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    blendMode: "exclude-mask",
    inputImage: some(block:
      if cache0.isNone() or epochTime() > cache0Time + 900.0:
        cache0 = some(block:
          self.node9.get(context))
        cache0Time = epochTime()
      cache0.get()),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
  ))
  scene.node4 = render_imageApp.App(nodeName: "render/image", nodeId: 4.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    inputImage: none(Image),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node14 = render_imageApp.App(nodeName: "render/image", nodeId: 14.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    blendMode: "inverse-mask",
    inputImage: some(block:
      if cache0.isNone() or epochTime() > cache0Time + 900.0:
        cache0 = some(block:
          self.node9.get(context))
        cache0Time = epochTime()
      cache0.get()),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
  ))
  scene.node11 = render_textApp.App(nodeName: "render/text", nodeId: 11.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_textApp.AppConfig(
    text: "mask",
    inputImage: none(Image),
    richText: "disabled",
    position: "center",
    vAlign: "middle",
    offsetX: 0.0,
    offsetY: 0.0,
    padding: 10.0,
    fontColor: parseHtmlColor("#ffffff"),
    fontSize: 32.0,
    borderColor: parseHtmlColor("#000000"),
    borderWidth: 2,
    overflow: "fit-bounds",
  ))
  scene.node15 = render_textApp.App(nodeName: "render/text", nodeId: 15.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_textApp.AppConfig(
    text: "inverse-mask",
    inputImage: none(Image),
    richText: "disabled",
    position: "center",
    vAlign: "middle",
    offsetX: 0.0,
    offsetY: 0.0,
    padding: 10.0,
    fontColor: parseHtmlColor("#ffffff"),
    fontSize: 32.0,
    borderColor: parseHtmlColor("#000000"),
    borderWidth: 2,
    overflow: "fit-bounds",
  ))
  scene.node13 = render_textApp.App(nodeName: "render/text", nodeId: 13.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_textApp.AppConfig(
    text: "exclude-mask",
    inputImage: none(Image),
    richText: "disabled",
    position: "center",
    vAlign: "middle",
    offsetX: 0.0,
    offsetY: 0.0,
    padding: 10.0,
    fontColor: parseHtmlColor("#ffffff"),
    fontSize: 32.0,
    borderColor: parseHtmlColor("#000000"),
    borderWidth: 2,
    overflow: "fit-bounds",
  ))
  scene.node3 = render_imageApp.App(nodeName: "render/image", nodeId: 3.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    inputImage: none(Image),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node16 = render_imageApp.App(nodeName: "render/image", nodeId: 16.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    blendMode: "mask",
    inputImage: some(block:
      if cache1.isNone() or epochTime() > cache1Time + 900.0:
        cache1 = some(block:
          self.node10.get(context))
        cache1Time = epochTime()
      cache1.get()),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
  ))
  scene.node5 = render_imageApp.App(nodeName: "render/image", nodeId: 5.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    inputImage: none(Image),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node17 = render_imageApp.App(nodeName: "render/image", nodeId: 17.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    blendMode: "inverse-mask",
    inputImage: some(block:
      if cache1.isNone() or epochTime() > cache1Time + 900.0:
        cache1 = some(block:
          self.node10.get(context))
        cache1Time = epochTime()
      cache1.get()),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
  ))
  scene.node7 = render_imageApp.App(nodeName: "render/image", nodeId: 7.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    inputImage: none(Image),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node18 = render_imageApp.App(nodeName: "render/image", nodeId: 18.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    blendMode: "exclude-mask",
    inputImage: some(block:
      if cache1.isNone() or epochTime() > cache1Time + 900.0:
        cache1 = some(block:
          self.node10.get(context))
        cache1Time = epochTime()
      cache1.get()),
    placement: "cover",
    offsetX: 0,
    offsetY: 0,
  ))
  scene.node19 = render_imageApp.App(nodeName: "render/image", nodeId: 19.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_imageApp.AppConfig(
    placement: "tiled",
    inputImage: none(Image),
    offsetX: 0,
    offsetY: 0,
    blendMode: "normal",
  ))
  scene.node21 = data_newImageApp.App(nodeName: "data/newImage", nodeId: 21.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: data_newImageApp.AppConfig(
    width: 30,
    height: 30,
    color: parseHtmlColor("#ffffff"),
    opacity: 1.0,
    renderNext: 0.NodeId,
  ))
  scene.node20 = render_splitApp.App(nodeName: "render/split", nodeId: 20.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_splitApp.AppConfig(
    rows: 2,
    columns: 2,
    hideEmpty: true,
    inputImage: some(block:
      if cache2.isNone():
        cache2 = some(block:
          self.node21.get(context))
      cache2.get()),
    render_functions: @[
      @[
        22.NodeId,
        0.NodeId,
      ],
      @[
        0.NodeId,
        22.NodeId,
      ],
    ],
    render_function: 0.NodeId,
  ))
  scene.node22 = render_colorApp.App(nodeName: "render/color", nodeId: 22.NodeId, scene: scene.FrameScene, frameConfig: scene.frameConfig, appConfig: render_colorApp.AppConfig(
    color: parseHtmlColor("#ababab"),
    inputImage: none(Image),
  ))
  runEvent(self, context)
  
{.pop.}

var exportedScene* = ExportedScene(
  publicStateFields: PUBLIC_STATE_FIELDS,
  persistedStateKeys: PERSISTED_STATE_KEYS,
  init: init,
  runEvent: runEvent,
  render: render
)

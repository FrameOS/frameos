name: FrameOS cross compilation

on:
  workflow_dispatch:
  push:
    paths:
      - frameos/**
      - backend/app/utils/cross_compile.py
      - backend/app/tasks/_frame_deployer.py
      - backend/bin/cross
      - backend/tools/cross-toolchain.Dockerfile
      - .github/workflows/frameos-cross.yml
  pull_request:
    paths:
      - frameos/**
      - backend/app/utils/cross_compile.py
      - backend/app/tasks/_frame_deployer.py
      - backend/bin/cross
      - backend/tools/cross-toolchain.Dockerfile
      - .github/workflows/frameos-cross.yml

jobs:
  determine-matrix:
    runs-on: ubuntu-24.04
    outputs:
      targets: ${{ steps.set-matrix.outputs.targets }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          MATRIX=$(python backend/bin/cross matrix)
          echo "targets=$MATRIX" >> "$GITHUB_OUTPUT"

  cross-build:
    needs: determine-matrix
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine-matrix.outputs.targets) }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Install backend dependencies
        run: |
          pip install -r backend/requirements.txt
      - name: Install Nim (prebuilt)
        if: matrix.runner == 'ubuntu-24.04-arm'
        env:
          NIM_VERSION: 2.2.4
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.nim"
          curl -L "https://archive.frameos.net/prebuilt-deps/${{ matrix.slug }}/nim-${NIM_VERSION}.tar.gz" -o /tmp/nim.tar.gz
          tar -xzf /tmp/nim.tar.gz -C "$HOME/.nim"
          echo "$HOME/.nim/nim-${NIM_VERSION}/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.nim/nim-${NIM_VERSION}/bin:$PATH"
          nim --version
      - name: Install Nim
        if: matrix.runner != 'ubuntu-24.04-arm'
        env:
          CHOOSENIM_NO_ANALYTICS: 1
        run: |
          curl https://nim-lang.org/choosenim/init.sh -sSf | sh -s -- -y
          echo "$HOME/.nimble/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.nimble/bin:$PATH"
          nim --version
      - name: Cross compile ${{ matrix.slug }}
        run: |
          cd frameos
          make cross-${{ matrix.slug }}
      - name: Smoke test frameos check
        run: |
          cd frameos/build/cross/${{ matrix.slug }}
          docker run --rm --platform ${{ matrix.platform }} -v "$PWD:/workspace:ro" ${{ matrix.image }} bash -c "set -euo pipefail; export DEBIAN_FRONTEND=noninteractive; apt-get update; SSL_PACKAGE=libssl3; if apt-cache show libssl3t64 >/dev/null 2>&1; then SSL_PACKAGE=libssl3t64; fi; apt-get install -y --no-install-recommends ca-certificates \$SSL_PACKAGE; /workspace/frameos check"